B. DEPLOY PHASE (VPS Only)

export VERSION=1.0.0
export REGISTRY=ghcr.io
export USERNAME=your-github-username
export IMAGE_NAME=${REGISTRY}/${USERNAME}/co-found-app:${VERSION}

sudo mkdir -p /opt/docker/co-found
sudo chown $USER:$USER /opt/docker/co-found
cd /opt/docker/co-found

git clone <your-repo-url> . || (git pull && git checkout main)

cat > .env << 'ENVEOF'
POSTGRES_USER=postgres
POSTGRES_PASSWORD=$(openssl rand -base64 32)
POSTGRES_DB=cofound_prod
JWT_SECRET=$(openssl rand -hex 32)
LETSENCRYPT_EMAIL=your-email@example.com
VITE_API_URL=https://co-found.uz
VITE_FRONTEND_URL=https://co-found.uz
VITE_GOOGLE_CLIENT_ID=your-client-id
ENVEOF

POSTGRES_PASSWORD_VAL=$(openssl rand -base64 32)
JWT_SECRET_VAL=$(openssl rand -hex 32)
sed -i "s/\$(openssl rand -base64 32)/${POSTGRES_PASSWORD_VAL}/" .env
sed -i "s/\$(openssl rand -hex 32)/${JWT_SECRET_VAL}/" .env
sed -i "s/your-email@example.com/your-actual-email@example.com/" .env
sed -i "s/your-client-id/your-actual-client-id/" .env

chmod 600 .env

echo ${GITHUB_TOKEN} | docker login ${REGISTRY} -u ${USERNAME} --password-stdin

docker pull ${IMAGE_NAME}

sed -i "s|image: co-found-app:.*|image: ${IMAGE_NAME}|" docker-compose.prod.yml

docker volume create co-found-postgres-data
docker volume create co-found-redis-data
docker volume create co-found-app-uploads
docker volume create co-found-traefik-acme

docker compose -f docker-compose.prod.yml pull

docker compose -f docker-compose.prod.yml up -d

docker compose -f docker-compose.prod.yml ps

docker compose -f docker-compose.prod.yml logs -f
